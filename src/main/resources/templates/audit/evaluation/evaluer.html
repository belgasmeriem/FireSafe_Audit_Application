<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="fr">

<head th:replace="~{fragments/navbar :: head}">
    <title>√âvaluation Audit - FireSafety Audit</title>
</head>

<body>

<div th:replace="~{fragments/navbar :: dropdown-overlay}"></div>
<nav th:replace="~{fragments/navbar :: navbar}"></nav>

<!-- Sidebar AUDITOR -->
<aside th:replace="~{fragments/sidebar-audits-auditor :: sidebar}"></aside>

<div class="main-content" id="mainContent">
    <div class="page-container">

        <!-- Header avec info audit -->
        <div class="evaluation-header">
            <div class="header-left">
                <button class="btn-back" onclick="history.back()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="audit-info">
                    <h1><i class="fas fa-clipboard-check me-2"></i>√âvaluation de l'Audit</h1>
                    <div class="audit-details">
                        <span class="detail-item">
                            <i class="fas fa-building"></i>
                            <strong th:text="${audit.etablissement.nom}">√âtablissement</strong>
                        </span>
                        <span class="detail-item">
                            <i class="fas fa-calendar"></i>
                            <span th:text="${#temporals.format(audit.dateAudit, 'dd/MM/yyyy')}">Date</span>
                        </span>
                        <span class="detail-item">
                            <i class="fas fa-shield-alt"></i>
                            <span th:text="${audit.norme.nom}">Norme</span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <div class="progress-summary">
                    <div class="progress-circle-large" id="globalProgress">
                        <svg width="100" height="100">
                            <circle class="bg-circle" cx="50" cy="50" r="45"></circle>
                            <circle class="progress-circle" cx="50" cy="50" r="45" id="progressCircle"></circle>
                        </svg>
                        <div class="progress-text">
                            <span id="progressPercent">0%</span>
                            <small>Compl√©t√©</small>
                        </div>
                    </div>
                </div>
                <button class="btn-save-draft" onclick="saveDraft()">
                    <i class="fas fa-save"></i>
                    Enregistrer brouillon
                </button>
                <button class="btn-submit-audit" onclick="submitAudit()">
                    <i class="fas fa-check-circle"></i>
                    Terminer l'audit
                </button>
            </div>
        </div>
        <div th:if="${isContreVisite}" class="alert alert-info contre-visite-alert">
            <div class="alert-icon">
                <i class="fas fa-redo-alt"></i>
            </div>
            <div class="alert-content">
                <h5>üîÑ Contre-visite - R√©√©valuation des Non-Conformit√©s</h5>
                <p>
                    Cette √©valuation concerne <strong>uniquement les
                    <span th:text="${nbCriteresAReevaluer}">5</span> crit√®res non conformes</strong>
                    identifi√©s lors de l'audit initial du
                    <span th:text="${#temporals.format(auditInitial.dateAudit, 'dd/MM/yyyy')}">28/01/2025</span>.
                </p>
                <p class="mb-0">
                    <strong>Taux initial :</strong>
                    <span th:text="${auditInitial.tauxConformite} + '%'">65%</span> |
                    <strong>Objectif :</strong> V√©rifier si les actions correctives ont √©t√© mises en place
                </p>
                <a th:href="@{/audits/{id}(id=${auditInitial.id})}"
                   class="btn btn-sm btn-outline-light mt-2">
                    <i class="fas fa-file-alt me-2"></i>Voir l'audit initial
                </a>
            </div>
        </div>


        <!-- Navigation par Sections -->
        <div class="sections-nav">
            <div class="sections-tabs" id="sectionsNav">
                <button class="section-tab active" th:each="section, iterStat : ${sections}"
                        th:id="'tab-section-' + ${section.id}"
                        th:onclick="'showSection(' + ${section.id} + ')'"
                        th:data-section-id="${section.id}">
                    <div class="tab-content">
                        <span class="tab-number" th:text="${iterStat.count}">1</span>
                        <span class="tab-title" th:text="${section.titre}">Section</span>
                        <span class="tab-progress">
                            <span class="progress-count" th:id="'progress-' + ${section.id}">0</span>
                            /
                            <span th:text="${section.criteres != null ? section.criteres.size() : 0}">5</span>
                        </span>
                    </div>
                    <div class="tab-indicator"></div>
                </button>
            </div>
        </div>

        <!-- Sections de Crit√®res -->
        <div class="evaluation-content">
            <th:block th:each="section : ${sections}">
                <div class="section-container" th:id="'section-' + ${section.id}" style="display: none;">
                    <div class="section-header">
                        <h2>
                            <span class="section-code" th:text="${section.code}">S1</span>
                            <span th:text="${section.titre}">Section Title</span>
                        </h2>
                        <p th:if="${section.description}" th:text="${section.description}">Description</p>
                    </div>

                    <!-- Liste des Crit√®res (tri√©s par code) -->
                    <div class="criteres-list">
                        <th:block th:if="${section.criteres != null and !section.criteres.isEmpty()}">
                            <th:block th:each="critere : ${section.criteres}">
                                <div class="critere-card" th:id="'critere-' + ${critere.id}"
                                     th:data-critere-id="${critere.id}">
                                    <!-- Header Crit√®re -->
                                    <div class="critere-header">
                                        <div class="critere-info">
                                            <span class="critere-code" th:text="${critere.code}">C1.1</span>
                                            <h3 class="critere-titre" th:text="${critere.libelle}">Titre du crit√®re</h3>
                                        </div>
                                        <div class="critere-meta">
                                           <span class="badge-criticite"
                                                 th:classappend="${critere.criticite != null ? 'criticite-' + critere.criticite.name().toLowerCase() : ''}"
                                                 th:text="${critere.criticite != null ? critere.criticite.name() : 'STANDARD'}">
                                                    Criticit√©
                                           </span>
                                            <span class="badge-obligatoire" th:if="${critere.obligatoire}">
                                                <i class="fas fa-star"></i> Obligatoire
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Description -->
                                    <div class="critere-body">
                                        <p class="critere-description" th:text="${critere.description}">Description</p>

                                        <!-- Preuves requises -->
                                        <div class="critere-preuves" th:if="${critere.preuvesRequises != null and !critere.preuvesRequises.isEmpty()}">
                                            <strong><i class="fas fa-paperclip"></i> Preuves requises :</strong>
                                            <p th:text="${critere.preuvesRequises}">Liste des preuves</p>
                                        </div>

                                        <!-- R√©f√©rence l√©gale -->
                                        <div class="critere-reference" th:if="${critere.referenceTexteLoi != null and !critere.referenceTexteLoi.isEmpty()}">
                                            <strong><i class="fas fa-gavel"></i> R√©f√©rence l√©gale :</strong>
                                            <p th:text="${critere.referenceTexteLoi}">R√©f√©rence</p>
                                        </div>
                                    </div>

                                    <!-- Formulaire d'√âvaluation -->
                                    <div class="critere-evaluation">
                                        <form th:id="'form-' + ${critere.id}" class="evaluation-form">
                                            <input type="hidden" name="critereId" th:value="${critere.id}">
                                            <input type="hidden" name="auditId" th:value="${audit.id}">

                                            <!-- Statut de Conformit√© -->
                                            <div class="form-group">
                                                <label class="form-label required">Statut de conformit√©</label>
                                                <div class="statut-buttons">
                                                    <button type="button" class="statut-btn conforme"
                                                            onclick="selectStatut(this, 'CONFORME')" data-statut="CONFORME">
                                                        <i class="fas fa-check-circle"></i>
                                                        <span>Conforme</span>
                                                    </button>
                                                    <button type="button" class="statut-btn partiel"
                                                            onclick="selectStatut(this, 'PARTIELLEMENT_CONFORME')" data-statut="PARTIELLEMENT_CONFORME">
                                                        <i class="fas fa-exclamation-triangle"></i>
                                                        <span>Partiellement</span>
                                                    </button>
                                                    <button type="button" class="statut-btn non-conforme"
                                                            onclick="selectStatut(this, 'NON_CONFORME')" data-statut="NON_CONFORME">
                                                        <i class="fas fa-times-circle"></i>
                                                        <span>Non conforme</span>
                                                    </button>
                                                    <button type="button" class="statut-btn non-applicable"
                                                            onclick="selectStatut(this, 'NON_APPLICABLE')" data-statut="NON_APPLICABLE">
                                                        <i class="fas fa-ban"></i>
                                                        <span>Non applicable</span>
                                                    </button>
                                                </div>
                                                <input type="hidden" name="statut" required>
                                            </div>

                                            <!-- Observation -->
                                            <div class="form-group">
                                                <label class="form-label">Observations</label>
                                                <textarea name="observation" rows="3"
                                                          placeholder="D√©taillez vos observations..."></textarea>
                                            </div>

                                            <!-- Champs conditionnels pour non-conformit√©s -->
                                            <div class="non-conformite-fields" style="display: none;">
                                                <div class="form-row">
                                                    <div class="form-group">
                                                        <label class="form-label required">Niveau d'urgence</label>
                                                        <select name="urgence">
                                                            <option value="">S√©lectionner...</option>
                                                            <option value="IMMEDIATE">Imm√©diate - Sous 48h</option>
                                                            <option value="COURT_TERME">Court terme - Sous 1 mois</option>
                                                            <option value="MOYEN_TERME">Moyen terme - Sous 3 mois</option>
                                                            <option value="LONG_TERME">Long terme - Sous 6 mois</option>
                                                        </select>
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="form-label">Date d'√©ch√©ance</label>
                                                        <input type="date" name="dateEcheance">
                                                    </div>
                                                </div>

                                                <div class="form-group">
                                                    <label class="form-label required">Action corrective</label>
                                                    <textarea name="actionCorrective" rows="2"
                                                              placeholder="D√©crivez l'action corrective n√©cessaire..."></textarea>
                                                </div>
                                            </div>

                                            <!-- Upload de preuves (uniquement pour NC et Partiel) -->
                                            <div class="form-group preuves-field" style="display: none;">
                                                <label class="form-label">Preuves (photos, documents)</label>
                                                <div class="upload-area" th:id="'upload-area-' + ${critere.id}">
                                                    <input type="file" th:id="'file-input-' + ${critere.id}"
                                                           multiple accept="image/*,.pdf" style="display: none;"
                                                           onchange="handleFileSelect(this)">
                                                    <button type="button" class="btn-upload"
                                                            th:onclick="'document.getElementById(\'file-input-' + ${critere.id} + '\').click()'">
                                                        <i class="fas fa-camera"></i>
                                                        Ajouter des preuves
                                                    </button>
                                                    <div class="files-preview" th:id="'preview-' + ${critere.id}"></div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </th:block>
                        </th:block>

                        <!-- Message si aucun crit√®re -->
                        <th:block th:if="${section.criteres == null or section.criteres.isEmpty()}">
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>Aucun crit√®re dans cette section</p>
                            </div>
                        </th:block>
                    </div>
                </div>
            </th:block>
        </div>

        <!-- Navigation bas de page -->
        <div class="bottom-navigation">
            <button class="btn-nav-prev" onclick="previousSection()" id="btnPrev">
                <i class="fas fa-chevron-left"></i>
                Section pr√©c√©dente
            </button>
            <button class="btn-nav-next" onclick="nextSection()" id="btnNext">
                Section suivante
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>

    </div>
</div>

<th:block th:replace="~{fragments/navbar :: navbar-scripts}"></th:block>

<script th:inline="javascript">
    /*<![CDATA[*/
    const auditId = /*[[${audit.id}]]*/ 1;
    const sections = /*[[${sections}]]*/ [];
    let currentSectionIndex = 0;
    let evaluations = {};
    let uploadedFiles = {};

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Initialisation de l\'√©valuation...');
        console.log('Audit ID:', auditId);
        console.log('Sections:', sections);

        if (sections && sections.length > 0) {
            initializeProgressCircle();

            loadSavedEvaluations();
            showSection(sections[0].id);
            updateGlobalProgress();
        } else {
            console.error('Aucune section disponible');
        }
    });

    function initializeProgressCircle() {
        const circle = document.getElementById('progressCircle');
        const circumference = 2 * Math.PI * 45;

        // D√©finir les propri√©t√©s CSS custom
        circle.style.strokeDasharray = circumference;
        circle.style.strokeDashoffset = circumference; // Commence √† 0%

        console.log('Cercle de progression initialis√©');
    }

    // Navigation entre sections
    function showSection(sectionId) {
        console.log('Affichage de la section:', sectionId);

        // Cacher toutes les sections
        document.querySelectorAll('.section-container').forEach(el => {
            el.style.display = 'none';
        });

        // Afficher la section s√©lectionn√©e
        const sectionElement = document.getElementById('section-' + sectionId);
        if (sectionElement) {
            sectionElement.style.display = 'block';
        }

        // Mettre √† jour les tabs
        document.querySelectorAll('.section-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        const tabElement = document.getElementById('tab-section-' + sectionId);
        if (tabElement) {
            tabElement.classList.add('active');
        }

        // Mettre √† jour l'index
        currentSectionIndex = sections.findIndex(s => s.id === sectionId);

        // Mettre √† jour les boutons de navigation
        updateNavigationButtons();

        // ‚úÖ SCROLL TO TOP - Remonter en haut de la page
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

    function nextSection() {
        if (currentSectionIndex < sections.length - 1) {
            showSection(sections[currentSectionIndex + 1].id);
        }
    }

    function previousSection() {
        if (currentSectionIndex > 0) {
            showSection(sections[currentSectionIndex - 1].id);
        }
    }

    function updateNavigationButtons() {
        const btnPrev = document.getElementById('btnPrev');
        const btnNext = document.getElementById('btnNext');

        if (btnPrev) btnPrev.disabled = currentSectionIndex === 0;
        if (btnNext) btnNext.disabled = currentSectionIndex === sections.length - 1;
    }

    function selectStatut(button, statut) {
        const form = button.closest('form');
        const statutInput = form.querySelector('input[name="statut"]');
        const critereCard = form.closest('.critere-card');

        // ‚úÖ V√©rifier si c'√©tait d√©j√† s√©lectionn√©
        const wasAlreadySelected = button.classList.contains('selected');

        // D√©s√©lectionner tous les boutons
        form.querySelectorAll('.statut-btn').forEach(btn => {
            btn.classList.remove('selected');
        });

        // S√©lectionner le bouton cliqu√©
        button.classList.add('selected');
        statutInput.value = statut;

        // Afficher/masquer les champs de non-conformit√©
        const ncFields = form.querySelector('.non-conformite-fields');
        const preuvesField = form.querySelector('.preuves-field');

        if (statut === 'NON_CONFORME' || statut === 'PARTIELLEMENT_CONFORME') {
            ncFields.style.display = 'block';
            ncFields.querySelectorAll('[name="urgence"], [name="actionCorrective"]').forEach(field => {
                field.required = true;
            });
            preuvesField.style.display = 'block';
        } else {
            ncFields.style.display = 'none';
            ncFields.querySelectorAll('[required]').forEach(field => {
                field.required = false;
            });
            preuvesField.style.display = 'none';
        }

        if (critereCard) {
            critereCard.classList.add('has-status');
        }

        // ‚úÖ METTRE √Ä JOUR LE PROGR√àS EN TEMPS R√âEL (seulement si c'√©tait pas d√©j√† s√©lectionn√©)
        if (!wasAlreadySelected) {
            updateSectionProgress();
            updateGlobalProgress();
        }
    }


    function collectAllEvaluations() {
        const allEvaluations = [];

        // Parcourir toutes les sections
        sections.forEach(section => {
            if (!section.criteres) return;

            section.criteres.forEach(critere => {
                const form = document.getElementById('form-' + critere.id);
                if (!form) return;

                const formData = new FormData(form);
                const statut = formData.get('statut');

                // ‚úÖ Ne collecter que les √©valuations avec un statut s√©lectionn√©
                if (!statut) return;

                const evaluationData = {
                    auditId: parseInt(formData.get('auditId')),
                    critereId: critere.id,
                    statut: statut,
                    observation: formData.get('observation') || null,
                    urgence: formData.get('urgence') || null,
                    actionCorrective: formData.get('actionCorrective') || null,
                    dateEcheance: formData.get('dateEcheance') || null,
                    files: uploadedFiles[critere.id] || []
                };

                allEvaluations.push(evaluationData);
            });
        });

        console.log('üìã √âvaluations collect√©es:', allEvaluations.length);
        return allEvaluations;
    }

    // Upload de fichiers
    function handleFileSelect(input) {
        const critereId = input.id.replace('file-input-', '');
        const preview = document.getElementById('preview-' + critereId);

        if (!uploadedFiles[critereId]) {
            uploadedFiles[critereId] = [];
        }

        Array.from(input.files).forEach(file => {
            uploadedFiles[critereId].push(file);

            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <i class="fas ${file.type.includes('image') ? 'fa-image' : 'fa-file-pdf'}"></i>
                <span>${file.name}</span>
                <span class="file-size">(${formatFileSize(file.size)})</span>
                <button type="button" onclick="removeFile('${critereId}', '${file.name}')" class="btn-remove">
                    <i class="fas fa-times"></i>
                </button>
            `;
            preview.appendChild(fileItem);
        });

        input.value = '';
    }

    function removeFile(critereId, fileName) {
        uploadedFiles[critereId] = uploadedFiles[critereId].filter(f => f.name !== fileName);

        const preview = document.getElementById('preview-' + critereId);
        Array.from(preview.children).forEach(item => {
            if (item.querySelector('span').textContent === fileName) {
                item.remove();
            }
        });
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Sauvegarder une √©valuation
    async function saveEvaluation(critereId) {
        const form = document.getElementById('form-' + critereId);
        const formData = new FormData(form);

        if (!formData.get('statut')) {
            showNotification('Veuillez s√©lectionner un statut de conformit√©', 'error');
            return;
        }

        const evaluationData = {
            auditId: parseInt(formData.get('auditId')),
            critereId: critereId,
            statut: formData.get('statut'),
            observation: formData.get('observation'),
            urgence: formData.get('urgence') || null,
            actionCorrective: formData.get('actionCorrective') || null,
            dateEcheance: formData.get('dateEcheance') || null
        };

        try {
            const response = await fetch('/api/evaluations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(evaluationData)
            });

            const result = await response.json();

            if (result.success) {
                evaluations[critereId] = result.data;

                // Upload des preuves si pr√©sentes
                if (uploadedFiles[critereId] && uploadedFiles[critereId].length > 0) {
                    await uploadPreuves(result.data.id, uploadedFiles[critereId]);
                }

                // Marquer comme compl√©t√©
                document.getElementById('critere-' + critereId).classList.add('evaluated');

                showNotification('√âvaluation enregistr√©e avec succ√®s', 'success');
                updateSectionProgress();
                updateGlobalProgress();
            } else {
                showNotification(result.message, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('Erreur lors de l\'enregistrement', 'error');
        }
    }

    // Upload des preuves
    async function uploadPreuves(evaluationId, files) {
        for (const file of files) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('description', '');

            try {
                await fetch(`/api/preuves/evaluation/${evaluationId}`, {
                    method: 'POST',
                    body: formData
                });
            } catch (error) {
                console.error('Error uploading file:', error);
            }
        }
    }

    // Mettre √† jour la progression
    function updateSectionProgress() {
        sections.forEach(section => {
            if (!section.criteres) return;

            let evaluated = 0;
            section.criteres.forEach(critere => {
                const form = document.getElementById('form-' + critere.id);
                if (form) {
                    const statutInput = form.querySelector('input[name="statut"]');
                    // ‚úÖ Compter si un statut est s√©lectionn√© (m√™me si pas encore sauvegard√©)
                    if (statutInput && statutInput.value) {
                        evaluated++;
                    }
                }
            });

            const progressElement = document.getElementById('progress-' + section.id);
            if (progressElement) {
                progressElement.textContent = evaluated;
            }
        });
    }

    function updateGlobalProgress() {
        let totalCriteres = 0;
        let evaluatedCriteres = 0;

        sections.forEach(section => {
            if (!section.criteres) return;

            totalCriteres += section.criteres.length;

            section.criteres.forEach(critere => {
                const form = document.getElementById('form-' + critere.id);
                if (form) {
                    const statutInput = form.querySelector('input[name="statut"]');
                    if (statutInput && statutInput.value) {
                        evaluatedCriteres++;
                    }
                }
            });
        });

        const percent = totalCriteres > 0 ? Math.round((evaluatedCriteres / totalCriteres) * 100) : 0;

        console.log(`üìä Progr√®s: ${evaluatedCriteres}/${totalCriteres} crit√®res (${percent}%)`);

        document.getElementById('progressPercent').textContent = percent + '%';

        // Animer le cercle
        const circle = document.getElementById('progressCircle');
        const circumference = 2 * Math.PI * 45;
        const offset = circumference - (percent / 100) * circumference;
        circle.style.strokeDashoffset = offset;
    }

    async function saveDraft() {
        const allEvaluations = collectAllEvaluations();

        if (allEvaluations.length === 0) {
            showNotification('Aucune √©valuation √† sauvegarder', 'warning');
            return;
        }

        console.log('üíæ Sauvegarde de', allEvaluations.length, '√©valuations...');

        try {
            // ‚úÖ Envoyer toutes les √©valuations en une seule requ√™te
            const response = await fetch(`/api/evaluations/batch`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(allEvaluations)
            });

            const result = await response.json();

            if (result.success) {
                // ‚úÖ Stocker les IDs des √©valuations cr√©√©es
                if (result.data && Array.isArray(result.data)) {
                    result.data.forEach(evaluation => {
                        evaluations[evaluation.critere.id] = evaluation;

                        // Marquer le crit√®re comme √©valu√©
                        const critereCard = document.getElementById('critere-' + evaluation.critere.id);
                        if (critereCard) {
                            critereCard.classList.add('evaluated');
                        }
                    });
                }

                // ‚úÖ Upload des preuves pour chaque √©valuation
                const uploadPromises = [];
                for (const evaluation of (result.data || [])) {
                    const files = uploadedFiles[evaluation.critere.id];
                    if (files && files.length > 0) {
                        uploadPromises.push(uploadPreuves(evaluation.id, files));
                    }
                }

                if (uploadPromises.length > 0) {
                    await Promise.all(uploadPromises);
                }

                updateSectionProgress();
                updateGlobalProgress();

                showNotification(`‚úÖ ${allEvaluations.length} √©valuations sauvegard√©es avec succ√®s`, 'success');

                // ‚úÖ Redirection apr√®s 1.5 secondes
                setTimeout(() => {
                    window.location.href = '/audits/en-cours';
                }, 1500);
            } else {
                showNotification(result.message || 'Erreur lors de la sauvegarde', 'error');
            }
        } catch (error) {
            console.error('‚ùå Erreur:', error);
            showNotification('Erreur lors de la sauvegarde du brouillon', 'error');
        }
    }
    // Soumettre l'audit
    async function submitAudit() {
        const allEvaluations = collectAllEvaluations();

        let totalCriteres = 0;
        sections.forEach(section => {
            if (section.criteres) {
                totalCriteres += section.criteres.length;
            }
        });

        console.log(`üìä Progression: ${allEvaluations.length}/${totalCriteres} crit√®res √©valu√©s`);

        if (allEvaluations.length < totalCriteres) {
            const manquants = totalCriteres - allEvaluations.length;
            if (!confirm(`‚ö†Ô∏è Il reste ${manquants} crit√®re(s) non √©valu√©(s).\n\nVoulez-vous vraiment terminer l'audit ?`)) {
                return;
            }
        }

        if (!confirm('‚úÖ √ätes-vous s√ªr de vouloir terminer cet audit ?\n\nCette action est irr√©versible.')) {
            return;
        }

        try {
            // ‚úÖ 1. Sauvegarder toutes les √©valuations
            if (allEvaluations.length > 0) {
                const saveResponse = await fetch(`/api/evaluations/batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(allEvaluations)
                });

                const saveResult = await saveResponse.json();

                if (!saveResult.success) {
                    showNotification('Erreur lors de la sauvegarde des √©valuations', 'error');
                    return;
                }

                // Upload des preuves
                if (saveResult.data && Array.isArray(saveResult.data)) {
                    const uploadPromises = [];
                    for (const evaluation of saveResult.data) {
                        const files = uploadedFiles[evaluation.critere.id];
                        if (files && files.length > 0) {
                            uploadPromises.push(uploadPreuves(evaluation.id, files));
                        }
                    }
                    if (uploadPromises.length > 0) {
                        await Promise.all(uploadPromises);
                    }
                }
            }

            const terminateResponse = await fetch(`/api/audits/${auditId}/soumettre`, {
                method: 'POST'
            });

            const terminateResult = await terminateResponse.json();

            if (terminateResult.success) {
                showNotification('‚úÖ Audit termin√© avec succ√®s !', 'success');
                setTimeout(() => {
                    window.location.href = '/audits/mes-audits';
                }, 1500);
            } else {
                showNotification(terminateResult.message || 'Erreur lors de la soumission', 'error');
            }
        } catch (error) {
            console.error('‚ùå Erreur:', error);
            showNotification('Erreur lors de la soumission de l\'audit', 'error');
        }
    }

    // Charger les √©valuations sauvegard√©es
    async function loadSavedEvaluations() {
        try {
            const response = await fetch(`/api/evaluations/audit/${auditId}`);
            const result = await response.json();

            if (result.success && result.data) {
                result.data.forEach(evaluation => {
                    evaluations[evaluation.critere.id] = evaluation;
                    populateForm(evaluation);
                });

                updateSectionProgress();
                updateGlobalProgress();
            }
        } catch (error) {
            console.error('Error loading evaluations:', error);
        }
    }

    function populateForm(evaluation) {
        const form = document.getElementById('form-' + evaluation.critere.id);
        if (!form) return;

        // S√©lectionner le statut
        const statutBtn = form.querySelector(`[data-statut="${evaluation.statut}"]`);
        if (statutBtn) {
            statutBtn.click();
        }

        // Remplir les champs
        if (evaluation.observation) {
            form.querySelector('[name="observation"]').value = evaluation.observation;
        }
        if (evaluation.urgence) {
            form.querySelector('[name="urgence"]').value = evaluation.urgence;
        }
        if (evaluation.actionCorrective) {
            form.querySelector('[name="actionCorrective"]').value = evaluation.actionCorrective;
        }
        if (evaluation.dateEcheance) {
            form.querySelector('[name="dateEcheance"]').value = evaluation.dateEcheance;
        }

        // Marquer comme √©valu√©
        document.getElementById('critere-' + evaluation.critere.id).classList.add('evaluated');
    }

    // Notification
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
            <span>${message}</span>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.classList.add('show');
        }, 100);

        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
    /*]]>*/
</script>

<style>
    :root {
        --primary: #006666;
        --success: #198754;
        --warning: #ffc107;
        --danger: #dc3545;
        --conforme: #198754;
        --partiel: #ffc107;
        --non-conforme: #dc3545;
        --non-applicable: #6c757d;
        --critique: #dc3545;
        --important: #ffc107;
        --standard: #6c757d;
    }

    .page-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    /* Header */
    .evaluation-header {
        background: white;
        padding: 25px;
        border-radius: 12px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 20px;
        flex: 1;
    }

    .btn-back {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: #f8f9fa;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
    }

    .btn-back:hover {
        background: var(--primary);
        color: white;
    }

    .audit-info h1 {
        margin: 0 0 10px 0;
        font-size: 1.5rem;
        color: #2c3e50;
    }

    .audit-details {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }

    .contre-visite-alert {
        background: linear-gradient(135deg, #0dcaf0, #0891b2);
        color: white;
        border: none;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(13,202,240,0.3);
        display: flex;
        gap: 15px;
        align-items: start;
    }

    .contre-visite-alert .alert-icon {
        font-size: 2rem;
        opacity: 0.9;
    }

    .contre-visite-alert h5 {
        margin: 0 0 10px 0;
        font-weight: 700;
        font-size: 1.1rem;
    }

    .contre-visite-alert p {
        margin: 5px 0;
        line-height: 1.6;
    }

    .contre-visite-alert .btn-outline-light {
        border-color: rgba(255,255,255,0.5);
        color: white;
    }

    .contre-visite-alert .btn-outline-light:hover {
        background: white;
        color: #0dcaf0;
    }

    .detail-item {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #6c757d;
        font-size: 0.9rem;
    }

    .detail-item i {
        color: var(--primary);
    }

    .header-right {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    /* Progress Circle */
    .progress-circle-large {
        position: relative;
        width: 100px;
        height: 100px;
    }

    .progress-circle-large svg {
        transform: rotate(-90deg);
    }

    .progress-circle-large .bg-circle {
        fill: none;
        stroke: #e9ecef;
        stroke-width: 8;
    }

    .progress-circle-large .progress-circle {
        fill: none;
        stroke: var(--primary);
        stroke-width: 8;
        stroke-linecap: round;
        stroke-dasharray: 283;
        stroke-dashoffset: 283;
        transition: stroke-dashoffset 0.5s ease;
    }

    .progress-circle-large .progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }

    .progress-circle-large .progress-text span {
        display: block;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary);
    }

    .progress-circle-large .progress-text small {
        font-size: 0.7rem;
        color: #6c757d;
    }

    .btn-save-draft {
        padding: 10px 20px;
        background: white;
        border: 2px solid var(--primary);
        color: var(--primary);
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }

    .btn-save-draft:hover {
        background: var(--primary);
        color: white;
    }

    .btn-submit-audit {
        padding: 10px 20px;
        background: linear-gradient(135deg, var(--success), #28a745);
        border: none;
        color: white;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }

    .btn-submit-audit:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(25,135,84,0.3);
    }

    /* Sections Navigation */
    .sections-nav {
        background: white;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        overflow-x: auto;
    }

    .sections-tabs {
        display: flex;
        gap: 10px;
        min-width: min-content;
    }

    .section-tab {
        flex: 1;
        min-width: 200px;
        padding: 15px;
        background: #f8f9fa;
        border: 2px solid transparent;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
    }

    .section-tab:hover {
        background: #e9ecef;
        transform: translateY(-2px);
    }

    .section-tab.active {
        background: linear-gradient(135deg, #004d4d, #006666, #008080);
        border-color: var(--primary);
        color: white;
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0,102,102,0.3);
    }

    .section-tab.active .tab-number {
        background: white;
        color: var(--primary);
    }

    .section-tab.active .tab-title {
        color: white;
        font-weight: 700;
    }

    .critere-card.has-status {
        border-left-color: #0d6efd !important;
    }

    .critere-card.has-status .critere-header {
        background: rgba(13,110,253,0.05);
    }

    .critere-card.has-status .critere-code::after {
        content: " ‚úì";
        color: var(--success);
    }

    .section-tab.active .tab-progress {
        color: rgba(255,255,255,0.9);
        font-weight: 600;
    }

    .tab-content {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .tab-number {
        width: 30px;
        height: 30px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9rem;
    }

    .tab-title {
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.95rem;
    }

    .tab-progress {
        color: #6c757d;
        font-size: 0.85rem;
    }

    .tab-indicator {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: white;
        transform: scaleX(0);
        transition: transform 0.3s;
        border-radius: 0 0 6px 6px;
    }

    .section-tab.active .tab-indicator {
        transform: scaleX(1);
    }

    /* Section Container */
    .section-container {
        margin-bottom: 20px;
    }

    .section-header {
        background: white;
        padding: 25px;
        border-radius: 12px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .section-header h2 {
        margin: 0 0 10px 0;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-code {
        display: inline-block;
        padding: 5px 12px;
        background: var(--primary);
        color: white;
        border-radius: 5px;
        font-size: 0.9rem;
        font-weight: 700;
    }

    .section-header p {
        margin: 0;
        color: #6c757d;
    }

    /* Crit√®re Card */
    .criteres-list {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .critere-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        overflow: hidden;
        border-left: 5px solid #e9ecef;
        transition: all 0.3s;
    }

    .critere-card.evaluated {
        border-left-color: var(--success);
    }

    .critere-header {
        padding: 20px;
        background: #f8f9fa;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }

    .critere-code {
        display: inline-block;
        padding: 4px 10px;
        background: var(--primary);
        color: white;
        border-radius: 5px;
        font-weight: 700;
        font-size: 0.85rem;
        margin-bottom: 8px;
    }

    .critere-titre {
        margin: 0;
        color: #2c3e50;
        font-size: 1.1rem;
    }

    .critere-meta {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .badge-criticite, .badge-obligatoire {
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .criticite-critique {
        background: rgba(220,53,69,0.15);
        color: var(--critique);
    }

    .criticite-important {
        background: rgba(255,193,7,0.15);
        color: var(--important);
    }

    .criticite-standard {
        background: rgba(108,117,125,0.15);
        color: var(--standard);
    }

    .badge-obligatoire {
        background: rgba(13,110,253,0.15);
        color: #0d6efd;
    }

    .critere-body {
        padding: 20px;
    }

    .critere-description {
        margin: 0 0 15px 0;
        color: #495057;
        line-height: 1.6;
    }

    .critere-preuves, .critere-reference {
        padding: 15px;
        background: rgba(13,110,253,0.05);
        border-left: 3px solid #0d6efd;
        border-radius: 5px;
        margin-bottom: 15px;
    }

    .critere-preuves strong, .critere-reference strong {
        color: #0d6efd;
        display: block;
        margin-bottom: 8px;
    }

    /* Formulaire d'√âvaluation */
    .critere-evaluation {
        padding: 20px;
        background: #fafbfc;
        border-top: 1px solid #e9ecef;
    }

    .evaluation-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .form-label {
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.9rem;
    }

    .form-label.required::after {
        content: " *";
        color: var(--danger);
    }

    /* Boutons de Statut */
    .statut-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
    }

    .statut-btn {
        padding: 15px;
        border: 2px solid #e9ecef;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }

    .statut-btn i {
        font-size: 1.5rem;
    }

    .statut-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .statut-btn.selected {
        border-width: 3px;
    }

    .statut-btn.conforme.selected {
        border-color: var(--conforme);
        background: rgba(25,135,84,0.05);
        color: var(--conforme);
    }

    .statut-btn.partiel.selected {
        border-color: var(--partiel);
        background: rgba(255,193,7,0.05);
        color: var(--partiel);
    }

    .statut-btn.non-conforme.selected {
        border-color: var(--non-conforme);
        background: rgba(220,53,69,0.05);
        color: var(--non-conforme);
    }

    .statut-btn.non-applicable.selected {
        border-color: var(--non-applicable);
        background: rgba(108,117,125,0.05);
        color: var(--non-applicable);
    }

    /* Inputs */
    textarea, input[type="text"], input[type="date"], input[type="number"], select {
        padding: 10px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 0.9rem;
        font-family: inherit;
        transition: border-color 0.3s;
    }

    textarea:focus, input:focus, select:focus {
        outline: none;
        border-color: var(--primary);
    }

    textarea {
        resize: vertical;
        min-height: 80px;
    }

    /* Upload Area */
    .upload-area {
        border: 2px dashed #e9ecef;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
    }

    .btn-upload {
        padding: 10px 20px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }

    .btn-upload:hover {
        background: #008080;
    }

    .files-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
    }

    .file-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
    }

    .file-item i {
        color: var(--primary);
    }

    .file-size {
        color: #6c757d;
        font-size: 0.85rem;
    }

    .btn-remove {
        width: 20px;
        height: 20px;
        border: none;
        background: var(--danger);
        color: white;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
    }

    /* Form Actions */
    .form-actions {
        display: flex;
        justify-content: flex-end;
        padding-top: 10px;
        border-top: 1px solid #e9ecef;
    }

    .btn-save {
        padding: 12px 24px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }

    .btn-save:hover {
        background: #008080;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,102,102,0.3);
    }

    /* Bottom Navigation */
    .bottom-navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        padding: 20px 0;
    }

    .btn-nav-prev, .btn-nav-next {
        padding: 12px 24px;
        background: white;
        border: 2px solid var(--primary);
        color: var(--primary);
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }

    .btn-nav-prev:hover, .btn-nav-next:hover {
        background: var(--primary);
        color: white;
    }

    .btn-nav-prev:disabled, .btn-nav-next:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.3;
    }

    /* Notification */
    .notification {
        position: fixed;
        top: 20px;
        right: -300px;
        background: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 10000;
        transition: right 0.3s ease;
    }

    .notification.show {
        right: 20px;
    }

    .notification-success {
        border-left: 4px solid var(--success);
        color: var(--success);
    }

    .notification-error {
        border-left: 4px solid var(--danger);
        color: var(--danger);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .evaluation-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .header-right {
            width: 100%;
            flex-direction: column;
        }

        .btn-save-draft, .btn-submit-audit {
            width: 100%;
            justify-content: center;
        }

        .statut-buttons {
            grid-template-columns: 1fr 1fr;
        }

        .form-row {
            grid-template-columns: 1fr;
        }
    }
</style>

</body>
</html>